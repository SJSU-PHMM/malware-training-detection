#This is a script to create Model from MSA, train the Model and test it against malware family and app Logs.
# It finally gives the AUC score for the model trained.

library("aphid")
library("cvAUC")

#Update this malware family based if you want to execute PHMM for only one particular family of Malwares
malwareFamily = "consolidated"

source("phmmUtils.R")
source("loadMSAFromFile.R")
source("trainModel.R")
source("testModel.R")

msaFile <- paste("data/msa/", malwareFamily,"_msa.txt" , sep= "")
trainingFile <- paste("data/training/", malwareFamily,"_training.txt" , sep= "")
testingFile <- paste("data/testing/", malwareFamily,"_testing.txt" , sep= "")

testAppFile <- paste("data/testing/", "app_testing.txt" , sep= "")

modelFileName <- paste("data/trainedModels/", malwareFamily , "_model.Rdata", sep="")

#set malware residues that characters from A-Z and numbers from 0-9
malware_residues <- c("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9","*")

#Load MSA sequences
malware.msa <- loadMSA(msaFile)
malware_initial.PHMM <- derivePHMM(malware.msa,k=2, residues = malware_residues)

malware_trained.PHMM <- trainModel(malware_initial.PHMM, trainingFile )

#Save Trained Model to file
print(paste("Saving trained model for family:",malwareFamily," to file ", modelFileName, sep=""))
saveRDS(malware_trained.PHMM, file=modelFileName)

#test the Model using malware Logs Files and app Log Sequences
results <- testModel(malware_trained.PHMM, testingFile, testAppFile)

aucValue <- AUC(results$probv, results$malwareLabels , label.ordering = NULL)

print(paste("AUC Score:",aucValue))
